<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC  
 "-//mybatis.org//DTD Mapper 3.0//EN"  
 "http://mybatis.org/dtd/mybatis-3-mapper.dtd">  
 
 
 <mapper namespace="joinMgmt">
 
	<!-- 연구항목  관리  항목 조회 -->
	<select id="selectMgmtItemList" parameterType="map" resultType="hashmap">
		SELECT DISTINCT `${SEARCH_ITEM }` as ITEM
		FROM	CC_ITEM_MGMT
		WHERE	1=1
		<if test="SCHEMA_VAL != null and SCHEMA_VAL != ''"> /* 테이블 조회 조건 */
			AND `SCHEMA` = #{SCHEMA_VAL }
		</if>
		<if test="TABLE_VAL != null and TABLE_VAL != ''"> /* 컬럼 조회 조건 */
			AND `TABLE` = #{TABLE_VAL }
		</if>
	</select>
	
	<!-- 연구항목  조인 관리  항목 조회 -->
	<select id="selectJoinItemList" parameterType="map" resultType="hashmap">
		SELECT *
		FROM
		(
			SELECT
			<choose>
				<when test='SEARCH_ITEM == "SCHEMA_1" or SEARCH_ITEM == "SCHEMA_2"'>
				SCHEMA_1 AS ITEM
				</when>
				
				<otherwise>
				TABLE_1 AS ITEM
				</otherwise>
			</choose>
			FROM	CC_ITEM_JOIN
			WHERE	1 = 1
			<if test="SCHEMA_VAL != null and SCHEMA_VAL != ''"> /* 테이블 조회 조건 */
				AND ( `SCHEMA_1` = #{SCHEMA_VAL } OR `SCHEMA_2` = #{SCHEMA_VAL } )
			</if>
			<choose>
				<when test='SEARCH_ITEM == "SCHEMA_1" or SEARCH_ITEM == "SCHEMA_2"'>
				GROUP BY SCHEMA_1
				</when>
				
				<otherwise>
				GROUP BY TABLE_1
				</otherwise>
			</choose>
			UNION
			SELECT	
			<choose>
				<when test='SEARCH_ITEM == "SCHEMA_1" or SEARCH_ITEM == "SCHEMA_2"'>
				SCHEMA_2 AS ITEM
				</when>
				
				<otherwise>
				TABLE_2 AS ITEM
				</otherwise>
			</choose>
				
			FROM	CC_ITEM_JOIN
			WHERE	1 = 1
			<if test="SCHEMA_VAL != null and SCHEMA_VAL != ''"> /* 테이블 조회 조건 */
			AND ( `SCHEMA_1` = #{SCHEMA_VAL } OR `SCHEMA_2` = #{SCHEMA_VAL } )
			</if>
		
			<choose>
				<when test='SEARCH_ITEM == "SCHEMA_1" or SEARCH_ITEM == "SCHEMA_2"'>
				GROUP BY SCHEMA_2
				</when>
				
				<otherwise>
				GROUP BY TABLE_2
				</otherwise>
			</choose>
		)A
		ORDER BY ITEM ASC

		<!-- SELECT DISTINCT `${SEARCH_ITEM }` as ITEM
		FROM	CC_ITEM_JOIN
		WHERE	1=1
		<if test="SCHEMA_VAL != null and SCHEMA_VAL != ''"> /* 테이블 조회 조건 */
			AND ( `SCHEMA_1` = #{SCHEMA_VAL } OR `SCHEMA_2` = #{SCHEMA_VAL } )
		</if> -->
	</select>
	
 	<!-- 연구항목 조인 관리 카운트 조회 -->
	<select id="selectJoinCount" parameterType="map" resultType="java.lang.Integer">
		SELECT COUNT(*) AS TOT_CNT
		FROM CC_ITEM_JOIN A
		WHERE 1=1
		<!-- RELATION1 -->
		<if test="SCHEMA_1 != null and SCHEMA_1 != ''">
			AND ( A.SCHEMA_1 = #{SCHEMA_1 } OR A.SCHEMA_2 = #{SCHEMA_1 } )
		</if>
		<if test="TABLE_1 != null and TABLE_1 != ''">
			AND ( A.TABLE_1 = #{TABLE_1 } OR A.TABLE_2 = #{TABLE_1 } )
		</if>
		
		<!-- RELATION2 -->
		<if test="SCHEMA_2 != null and SCHEMA_2 != ''">
			AND ( A.SCHEMA_1 = #{SCHEMA_2 } OR A.SCHEMA_2 = #{SCHEMA_2 } )
		</if>
		<if test="TABLE_2 != null and TABLE_2 != ''">
			AND ( A.TABLE_1 = #{TABLE_2 } OR A.TABLE_2 = #{TABLE_2 } )
		</if>
		
		<if test="SEARCH_VAL != null and SEARCH_VAL != ''">
			AND ( A.COLUMN_1 = #{SEARCH_VAL } OR A.COLUMN_2 = #{SEARCH_VAL } )
		</if>
		
	</select>
 
 	<!-- 연구항목 조인 관리 조회 -->
	<select id="selectJoinList" parameterType="map" resultType="hashmap">
		SELECT *
		FROM	
		(
			SELECT @RNUM := @RNUM + 1 AS NUM,
					A.*
			FROM
			(
				SELECT A.SCHEMA_1	/* 스키마명 */
						, A.TABLE_1		/* 테이블명 */
						, A.COLUMN_1		/* 컬럼명 */
						, A.SCHEMA_2		/* 조인 스키마명 */
						, A.TABLE_2		/* 조인 테이블명 */
						, A.COLUMN_2		/* 조인 컬럼명 */
				FROM CC_ITEM_JOIN A
				WHERE 1=1
				<!-- RELATION1 -->
				<if test="SCHEMA_1 != null and SCHEMA_1 != ''">
					AND ( A.SCHEMA_1 = #{SCHEMA_1 } OR A.SCHEMA_2 = #{SCHEMA_1 } )
				</if>
				<if test="TABLE_1 != null and TABLE_1 != ''">
					AND ( A.TABLE_1 = #{TABLE_1 } OR A.TABLE_2 = #{TABLE_1 } )
				</if>
				
				<!-- RELATION2 -->
				<if test="SCHEMA_2 != null and SCHEMA_2 != ''">
					AND ( A.SCHEMA_1 = #{SCHEMA_2 } OR A.SCHEMA_2 = #{SCHEMA_2 } )
				</if>
				<if test="TABLE_2 != null and TABLE_2 != ''">
					AND ( A.TABLE_1 = #{TABLE_2 } OR A.TABLE_2 = #{TABLE_2 } )
				</if>
				
				<if test="SEARCH_VAL != null and SEARCH_VAL != ''">
					AND ( A.COLUMN_1 = #{SEARCH_VAL } OR A.COLUMN_2 = #{SEARCH_VAL } )
				</if>
				ORDER BY A.SCHEMA_1 ASC
			)A ,
			(SELECT @RNUM := 0 ) R
		)TB1 WHERE 1=1
		LIMIT #{start},#{length}
	
	</select>
	
	<!-- 연구항목 조인 관리 등록 중복체크 -->
	<select id="insertJoinCheck" parameterType="map" resultType="java.lang.Integer">
		SELECT COUNT(*) AS TOT_CNT
		FROM  CC_ITEM_JOIN
		WHERE SCHEMA_1 = #{SCHEMA_1 } 
		AND TABLE_1 = #{TABLE_1 }
		AND COLUMN_1 = #{COLUMN_1 }
		AND SCHEMA_2 = #{SCHEMA_2 } 
		AND TABLE_2 = #{TABLE_2 }
		AND COLUMN_2 = #{COLUMN_2 }
		
	</select>
	
	<!-- 연구항목 조인 관리 등록 -->
	<insert id="insertJoin" parameterType="map">
		INSERT INTO CC_ITEM_JOIN
		(
			SCHEMA_1		/* 스키마명 */
			, TABLE_1		/* 테이블명 */
			, COLUMN_1	/* 컬럼명 */
			, SCHEMA_2	/* 조인 스키마명 */
			, TABLE_2		/* 조인 테이블명 */
			, COLUMN_2	/* 조인 컬럼명 */
			, CRT_DT		/* 생성일자 */
		)
		VALUES(
				#{SCHEMA_1 }
			, #{TABLE_1 }
			, #{COLUMN_1 }
			, #{SCHEMA_2 }
			, #{TABLE_2 }
			, #{COLUMN_2 }
			, NOW()
		)

	</insert>
	
	<!-- 연구항목 조인 관리 삭제-->
	<delete id="deleteJoin" parameterType="map">
		DELETE FROM  CC_ITEM_JOIN
		WHERE SCHEMA_1 = #{SCHEMA_1 } 
		AND TABLE_1 = #{TABLE_1 }
		AND COLUMN_1 = #{COLUMN_1 }
		AND SCHEMA_2 = #{SCHEMA_2 } 
		AND TABLE_2 = #{TABLE_2 }
		AND COLUMN_2 = #{COLUMN_2 }

	</delete>

</mapper>
 
 
 