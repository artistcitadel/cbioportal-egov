<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC  
 "-//mybatis.org//DTD Mapper 3.0//EN"  
 "http://mybatis.org/dtd/mybatis-3-mapper.dtd">  
 
 
 <mapper namespace="sys_user_data_mgmt">
 
 	<!-- 사용자 카운트 조회 -->
	<select id="selectUserDataList" parameterType="map" resultType="hashmap">
		SELECT *
		FROM
		(
			SELECT @RNUM := @RNUM + 1 AS NUM
					,TB1.CONT_SEQ
					,TB1.DATA_SEQ
					,TB1.PER_CODE
					,TB1.PER_NAME
					,TB1.METH_CD
					,TB1.METH_NM
					,TB1.CONDT_NM
					,TB1.DATA_NM
					,TB1.TABLE_ID
					,TB1.TABLE_CNT
					,TB1.TABLE_SIZE
					,TB1.UDT_DT
					,TB1.MON_DIFF
					,TB1.TOTAL_TABLE_SIZE
			FROM (
				SELECT 	 A.SEQ AS CONT_SEQ
						,B.SEQ AS DATA_SEQ
						,A.PER_CODE
						,(SELECT MAX(PER_NAME) FROM CC_PERINX WHERE PER_CODE=A.PER_CODE GROUP BY PER_CODE) AS PER_NAME
						,A.METH_CD
						,(SELECT COMM_CD_NM FROM CC_COMMON_CODE WHERE COMM_GRP_ID = 'CDW_METH_CD' AND COMM_CD_ID=A.METH_CD) AS METH_NM
						,A.CONDT_NM
						,B.DATA_NM
						,B.TABLE_ID
						,IFNULL(B.TABLE_CNT,'-') AS TABLE_CNT
						,IFNULL(B.TABLE_SIZE,'-') AS TABLE_SIZE
						,DATE_FORMAT( B.UDT_DT, "%Y-%m-%d %H:%m:%s" ) AS UDT_DT
						,TIMESTAMPDIFF(MONTH,B.CRT_DT,NOW()) AS MON_DIFF
						,IFNULL((
							SELECT 	SUM(Y.TABLE_SIZE)
							FROM 	CC_ITEM_CONT X,
									CC_ITEM_CONT_DATA Y,
									CC_PERINX Z
							WHERE	1=1
							AND 	X.SEQ=Y.CONT_SEQ
							AND 	X.PER_CODE=Z.PER_CODE
							AND 	X.PER_CODE=A.PER_CODE
							AND 	X.SHARE_CD='P'	
							<if test="SEARCH_PER_CODE != null and SEARCH_PER_CODE != ''">
							AND 	X.PER_CODE=#{SEARCH_PER_CODE}
							</if>
						),0) AS TOTAL_TABLE_SIZE
				FROM 	CC_ITEM_CONT A,
						CC_ITEM_CONT_DATA B,
						CC_PERINX C
				WHERE	1=1
				AND 	A.SEQ=B.CONT_SEQ
				AND 	A.PER_CODE=C.PER_CODE
				AND 	A.SHARE_CD='P'
				AND 	A.METH_CD != 'RG'
				<if test="SEARCH_PER_CODE != null and SEARCH_PER_CODE != ''">
				AND 	A.PER_CODE=#{SEARCH_PER_CODE}
				</if>
				<if test="SEARCH_VAL != null and SEARCH_VAL != ''">
					<choose>
						<when test="SEARCH_KEY == 1">
							AND 	UPPER(C.PER_NAME) LIKE CONCAT('%',UPPER(#{SEARCH_VAL}),'%') 
						</when>
						<when test="SEARCH_KEY == 2">
							AND 	UPPER(A.CONDT_NM) LIKE CONCAT('%',UPPER(#{SEARCH_VAL}),'%')
						</when>
						<when test="SEARCH_KEY == 3">
							AND 	UPPER(B.DATA_NM) LIKE CONCAT('%',UPPER(#{SEARCH_VAL}),'%')
						</when>
						
						<otherwise>
							AND 
							(
									UPPER(C.PER_NAME) LIKE CONCAT('%',UPPER(#{SEARCH_VAL}),'%') 
									OR	UPPER(A.CONDT_NM) LIKE CONCAT('%',UPPER(#{SEARCH_VAL}),'%')
									OR	UPPER(B.DATA_NM) LIKE CONCAT('%',UPPER(#{SEARCH_VAL}),'%')
							)
						</otherwise>
					</choose>
				</if>
				
				<if test="SEARCH_START_DATE != null and SEARCH_START_DATE != '' and SEARCH_END_DATE != null and SEARCH_END_DATE != '' ">
					AND B.CRT_DT BETWEEN #{SEARCH_START_DATE} AND #{SEARCH_END_DATE}
				</if>
				ORDER BY A.SEQ DESC
			)TB1, 
			(SELECT @RNUM := 0) R
		)TB2 WHERE 1=1
		ORDER BY TB2.CONT_SEQ DESC,TB2.DATA_SEQ ASC
		LIMIT #{start},#{length}
	</select>
	
	<select id="selectUserDataCount" parameterType="map" resultType="hashmap">
		SELECT 	COUNT(*) AS CNT
		FROM 	CC_ITEM_CONT A,
				CC_ITEM_CONT_DATA B,
				CC_PERINX C
		WHERE	1=1
		AND 	A.SEQ=B.CONT_SEQ
		AND 	A.PER_CODE=C.PER_CODE
		AND 	A.SHARE_CD='P'
		AND 	A.METH_CD != 'RG'
		<if test="SEARCH_VAL != null and SEARCH_VAL != ''">
			<choose>
				<when test="SEARCH_KEY == 1">
					AND 	UPPER(C.PER_NAME) LIKE CONCAT('%',UPPER(#{SEARCH_VAL}),'%') 
				</when>
				<when test="SEARCH_KEY == 2">
					AND 	UPPER(A.CONDT_NM) LIKE CONCAT('%',UPPER(#{SEARCH_VAL}),'%')
				</when>
				<when test="SEARCH_KEY == 3">
					AND 	UPPER(B.DATA_NM) LIKE CONCAT('%',UPPER(#{SEARCH_VAL}),'%')
				</when>
				
				<otherwise>
					AND 
					(
							UPPER(C.PER_NAME) LIKE CONCAT('%',UPPER(#{SEARCH_VAL}),'%') 
							OR	UPPER(A.CONDT_NM) LIKE CONCAT('%',UPPER(#{SEARCH_VAL}),'%')
							OR	UPPER(B.DATA_NM) LIKE CONCAT('%',UPPER(#{SEARCH_VAL}),'%')
					)
				</otherwise>
			</choose>
		</if>
		
		<if test="SEARCH_START_DATE != null and SEARCH_START_DATE != '' and SEARCH_END_DATE != null and SEARCH_END_DATE != '' ">
			AND B.CRT_DT BETWEEN #{SEARCH_START_DATE} AND #{SEARCH_END_DATE}
		</if>
	</select>
	
	<delete id="deleteItemContDataDetl" parameterType="map">
		DELETE FROM CC_ITEM_CONT_DATA_DETL WHERE SEQ=#{DATA_SEQ}
	</delete>
	
	<delete id="deleteItemContData" parameterType="map">
		DELETE FROM CC_ITEM_CONT_DATA WHERE SEQ=#{DATA_SEQ}
	</delete>
	
	<delete id="dropUserDataTable" parameterType="map">
		<if test="TABLE_ID != '' and TABLE_ID != null">
			DROP TABLE ${TABLE_ID}
		</if>
		
	</delete>
	
	<select id="selectUserDataTableSize" parameterType="map" resultType="hashmap">
		<choose>
			<when test='GV_DB_TYPE == "VERTICA"'>
				SELECT /*+ LABEL(COMPRESSED_TABLE_SIZE)*/
				       	A.ANCHOR_TABLE_SCHEMA, 
				       	A.ANCHOR_TABLE_NAME, 
				       	SUM(A.ROW_COUNT) AS ROW_COUNT,
				       	SUM(A.USED_BYTES) AS USED_COMPRESSED_MB,
				       	'Y' AS IS_SIZE
				FROM   	V_MONITOR.PROJECTION_STORAGE A
				WHERE 	1=1
				AND 	A.ANCHOR_TABLE_SCHEMA || '.' ||A.ANCHOR_TABLE_NAME=#{TABLE_ID}
				GROUP  BY A.ANCHOR_TABLE_SCHEMA, 
				          A.ANCHOR_TABLE_NAME
				ORDER  BY SUM(USED_BYTES) DESC
			</when>
			
			<otherwise>
				SELECT 	SUBSTR( TABSCHEMA, 1, 18 ) AS ANCHOR_TABLE_SCHEMA, 
				       	SUBSTR( TABNAME, 1, 30 ) AS ANCHOR_TABLE_NAME, 
				       	SUM(0) AS ROW_COUNT,
				       	SUM(COL_OBJECT_P_SIZE + INDEX_OBJECT_P_SIZE + LONG_OBJECT_P_SIZE + LOB_OBJECT_P_SIZE + XML_OBJECT_P_SIZE) AS USED_COMPRESSED_MB,
				       	MAX('Y') AS IS_SIZE
				FROM   	SYSIBMADM.ADMINTABINFO A
				WHERE 	1=1
				AND 	A.TABSCHEMA || '.' ||A.TABNAME = #{TABLE_ID}
				GROUP BY TABSCHEMA,TABNAME
			</otherwise>
		</choose>
	</select>


</mapper>
 
 
 