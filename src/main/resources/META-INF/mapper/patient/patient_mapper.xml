<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC
        "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="patientcpm">

    <select id="selectPatientChoiceList" resultType="com.asan.patient.vo.Patient">
      SELECT DISTINCT
                RESCH_PAT_ID patientId,
                'xxxx' sampleId,
                '9999' age,
                'xxxx' cancerStudies,
                'xxxxx' cancerType,
                'xxxx' cancerTypeDetails
     FROM CLSPNEXRT
    </select>

    <select id="selectLabTestHrc" resultType="com.asan.patient.vo.Patient">
      SELECT DISTINCT
                'Lab_test' subject,
                EXAM_CD id,
                IFNULL(EXAM_ENG_NM, EXAM_CD) name
                FROM CLSPNEXRT
      <![CDATA[
        WHERE LENGTH(EXAM_CD) < 6
      ]]>
    </select>

    <select id="selectLabTest" resultType="com.asan.patient.vo.Patient">
     SELECT
     'Lab_test' subject,
     EXAM_SLIP_CD pid ,
                         EXAM_CD id,
                         IFNULL(EXAM_ENG_NM, EXAM_CD) name,
                         RCEP_DT time,
                         ROUND(IFNULL(SUM(EXAM_RSLT_VAL),0),2) exam,
                         ROUND(IFNULL(SUM(MARK_RSLT_VAL),0),2) mark,
                         ROUND(IFNULL(SUM(CRTE_MSR_VAL),0),2)  crte

        FROM CLSPNEXRT
        /*WHERE RESCH_PAT_ID = '6905950076' AND EXAM_CD IN ('DA0036','BD0012','BA0094') AND SUBSTRING(RCEP_DT,1,4) = '2017' OR (EXAM_CD='BD0012' AND RCEP_DT='20040427')*/
        WHERE RESCH_PAT_ID = '6905950076' /*AND EXAM_CD = 'AFIN'*/
        /*AND EXAM_ENG_NM = 'Rh variant Ag,Automation (Semi-Qn)[Agglutination],Blood'*/
        GROUP BY EXAM_SLIP_CD, EXAM_CD, EXAM_ENG_NM, RCEP_DT
        ORDER BY 2,3,5
        LIMIT  100
 	</select>

    <select id="selectPatientMuList_temp" resultType="com.asan.patient.vo.PatientMut">
    SELECT MTTN_EXAM_RSLT_ID mttnExamRsltId,
            RESCH_PAT_ID reschPatId,
            GENE_EXAM_SPCN_ID geneExamSpcnId,
            EXAM_NO examNo,
            GENE_EXAM_MTH_NM geneExamMthNm,
            CHRM_NO chrnNo,
            GENE_NM geneNm,
            GENE_VARI_ST_LOC_VAL geneVariStLocVal,
            GENE_VARI_END_LOC_VAL geneVariEndLocVal,
            DNA_STRND_VAL dnaStandVal,
            GENE_VARI_CLSF_NM geneVariClsfNm,
            GENE_VARI_TYP_NO geneVariTypNo,
            REF_ALLELE_SQNC_VAL refAlleleSqncVal,
            VARI_ALLELE_SQNC_VAL variAlleleSqncVal,
            MTTN_STAT_NO mttnStatNo,
            HGVSC_VAL hgvscVal,
            HGVSP_VAL hgvspVal,
            TOT_ALLELE_READ_CNT totAlleleReadCnt,
            REF_ALLELE_READ_CNT refAlleleReadCnt,
            VARI_ALLELE_READ_CNT variAlleleReadCnt,
            VARI_ALLELE_READ_RT variAlleleReadRt,
            EXON_LOC_VAL exonLocVal,
            INTRN_LOC_VAL intrnLocVal,
            TRSC_ID trscId
            FROM PMGERMUEM
            WHERE RESCH_PAT_ID = #{patientId}
 	</select>

    <select id="selectPatientMuList" resultType="com.asan.patient.vo.PatientMut">
        SELECT GMU.MTTN_EXAM_RSLT_ID mttnExamRsltId        -- 돌연변이검사결과ID (화면표시X)
     , GMU.GENE_NM geneNm                  -- Gene
     , GMU.GENE_EXAM_MTH_NM geneExamMthNm         -- Methods
     , GMU.HGVSP_VAL  hgvspVal               -- Protein Change
     , GMU.CHRM_NO chrnNo                  -- Chromosome
     , GMU.GENE_VARI_ST_LOC_VAL  geneVariStLocVal    -- Start Pos
     , GMU.GENE_VARI_END_LOC_VAL    geneVariEndLocVal -- End Pos
     , GMU.REF_ALLELE_SQNC_VAL     refAlleleSqncVal  -- Ref
     , GMU.VARI_ALLELE_SQNC_VAL     variAlleleSqncVal -- Var
     , MST.MTTN_STAT_NM     ms         -- MS
     , GMU.GENE_VARI_CLSF_NM  geneVariClsfNm       -- Mutation Type
     , GMU.VARI_ALLELE_READ_RT  variAlleleReadRt     -- Allele Freq
     , GMU.TOT_ALLELE_READ_CNT  totAlleleReadCnt     -- 총대립유전자리드수 (화면표시X)
     , GMU.VARI_ALLELE_READ_CNT  variAlleleReadCnt    -- Variant Reads
     , GMU.REF_ALLELE_READ_CNT   refAlleleReadCnt    -- Ref Reads
     , CASE WHEN GCV.GENE_NM IS NULL THEN 'Diploid' ELSE 'Amplification' END AS copy   -- Copy #
     , ROUND((SELECT COUNT(*) FROM pmsdev.PMGERMUEM WHERE GENE_NM = GMU.GENE_NM) / (SELECT COUNT(*) FROM pmsdev.PMGERMUEM) * 100, 1) AS chort1   -- Cohort (밝은색)
     , ROUND((SELECT COUNT(*) FROM pmsdev.PMGERMUEM WHERE GENE_NM = GMU.GENE_NM AND HGVSP_VAL = GMU.HGVSP_VAL) / (SELECT COUNT(*) FROM pmsdev.PMGERMUEM) * 100, 1) AS chort2   -- Cohort (진한색)
     , SUM(MCS.GENE_VARI_OCCUR_CNT)  cosmic -- COSMIC
  FROM pmsdev.PMGERMUEM GMU
  LEFT OUTER JOIN pmsdev.PMGERMUCS MCS
    ON GMU.MTTN_EXAM_RSLT_ID = MCS.MTTN_EXAM_RSLT_ID
  LEFT OUTER JOIN pmsdev.PMGEMMUST MST
    ON GMU.MTTN_STAT_NO = MST.MTTN_STAT_NO
  LEFT OUTER JOIN pmsdev.PMGERCVEM GCV
    ON GMU.RESCH_PAT_ID = GCV.RESCH_PAT_ID
   AND GMU.GENE_NM      = GCV.GENE_NM
 WHERE GMU.RESCH_PAT_ID = '10510117' -- 연구환자ID (조회조건)
 GROUP BY
       GMU.GENE_NM
     , GMU.GENE_EXAM_MTH_NM
     , GMU.HGVSP_VAL
     , GMU.CHRM_NO
     , GMU.GENE_VARI_ST_LOC_VAL
     , GMU.GENE_VARI_END_LOC_VAL
     , GMU.REF_ALLELE_SQNC_VAL
     , GMU.VARI_ALLELE_SQNC_VAL
     , MST.MTTN_STAT_NM
     , GMU.GENE_VARI_CLSF_NM
     , GMU.VARI_ALLELE_READ_RT
     , GMU.VARI_ALLELE_READ_CNT
     , GMU.REF_ALLELE_READ_CNT
     , GCV.GENE_NM
    </select>

    <select id="selectPatientMuCosmic" resultType="com.asan.patient.vo.PatientMut">
       SELECT MCS.CSMC_ID                 -- COSMIC ID
       , MCS.HGVSP_VAL               -- Protein Change
       , MCS.GENE_VARI_OCCUR_CNT     -- Occurrence
       FROM pmsdev.PMGERMUCS MCS
       WHERE MCS.MTTN_EXAM_RSLT_ID = 'SNM0000039124'      -- 돌연변이검사결과ID (조회조건)
    </select>

</mapper>


