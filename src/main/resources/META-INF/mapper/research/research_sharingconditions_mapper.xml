<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC  
 "-//mybatis.org//DTD Mapper 3.0//EN"  
 "http://mybatis.org/dtd/mybatis-3-mapper.dtd">  
 
 <!-- 조건공유 -->
 <mapper namespace="research_sharingconditions">
	
	<!-- 중복체크 -->
	<select id="chkDuplCondNmList" parameterType="map" resultType="hashmap">
		SELECT *
		FROM CC_ITEM_CONT
		WHERE 1=1
		AND PER_CODE = #{PER_CODE}
		AND CONDT_NM = #{CONDT_NM}
	</select>
	
	<!-- 조회조건정보 저장 -->
	<insert id="insertItemCont" parameterType="map" useGeneratedKeys="true" keyProperty="SEQ">
		<choose>
			<when test="SHARE_CD == 'MU'">
				INSERT INTO pmsportal.CC_ITEM_CONT(
					 SHARE_CD
					,PER_CODE
					,CONT_NM
					,CONT_DESC
					,CONT_NUM
					,CATE_DETL_SEQ
					,CRT_ID
					,CRT_DT
					,UDT_ID
					,UDT_DT
				)VALUES(
					 #{SHARE_CD}
					,#{PER_CODE}
					,#{CONT_NM}
					,#{CONT_DESC}
					,#{CONT_NUM}
					,#{CATE_DETL_SEQ}
					,#{CRT_ID}
					,NOW()
					,#{UDT_ID}
					,NOW()
				)
			</when>
			<otherwise>
				INSERT INTO CC_ITEM_CONT(
					 SHARE_CD
					,CONDT_NM
					,PER_CODE
					,METH_CD
					,CC_POP_NUM
					,CC_CASE_NUM
					,CC_SAM_NUM
					,CC_CONT_CD
					,CC_MAT_CD
					,CC_AGE_NUM
					,SAVE_CD,DEPT_CODE,INSTCD,UDT_DT,CRT_DT
					
				)VALUES(
					 #{SHARE_CD},#{CONDT_NM},#{PER_CODE},#{METH_CD}
					,#{CC_POP_NUM},#{CC_CASE_NUM},#{CC_SAM_NUM},#{CC_CONT_CD},#{CC_MAT_CD},#{CC_AGE_NUM}
					,#{SAVE_CD},#{DEPT_CODE},#{INSTCD},NOW(),NOW()
				)
			</otherwise>
		</choose>
		
	</insert>
	
	<!-- 조회조건정보 수정 -->
	<update id="updateItemCont" parameterType="map">
		UPDATE   CC_ITEM_CONT  A
		SET		 CONDT_NM 	 = #{CONDT_NM}
				,CC_POP_NUM	 = IFNULL(#{CC_POP_NUM},CC_POP_NUM)
				,CC_CASE_NUM = IFNULL(#{CC_CASE_NUM},CC_CASE_NUM)
				,CC_SAM_NUM	 = IFNULL(#{CC_SAM_NUM},CC_SAM_NUM)
				,CC_CONT_CD	 = IFNULL(#{CC_CONT_CD},CC_CONT_CD)
				,CC_MAT_CD	 = IFNULL(#{CC_MAT_CD},CC_MAT_CD)
				,CC_AGE_NUM	 = IFNULL(#{CC_AGE_NUM},CC_AGE_NUM)
				,SAVE_CD 	 = #{SAVE_CD}
				,INSTCD 	 = #{INSTCD}
				,A.UDT_DT	 = NOW()
		WHERE	A.SEQ=#{SEQ}
	</update>
	
	
	<!-- 조회조건상세정보 저장 -->
	<insert id="insertItemContDetl" parameterType="map">
		INSERT INTO CC_ITEM_CONT_DETL(
			 ITEM_SEQ 	,CONT_SEQ 	,PER_CODE 	,`ORDER` 	,INC_EXC 	,TAB_CD 	,GR_LV
			,INPUT_VAL0 ,INPUT_VAL1 ,INPUT_VAL2 ,CNT 		,AGG 		,AND_OR
			,FIRST_YN 	,BASE_DT_YN ,RANGE_CD 	,RANGE_DN 	,DELETE_YN 	,ITEM_TEXT 	,IS_NULL_OR_BLANK 	,UDT_DT 	,CRT_DT
		
		)VALUES(
			 #{ITEM_SEQ} 	,#{CONT_SEQ} 	,#{PER_CODE} 	,#{ORDER} 	,#{INC_EXC} 	,#{TAB_CD} 	,#{GR_LV}
			,#{INPUT_VAL0} 	,#{INPUT_VAL1} 	,#{INPUT_VAL2} 	,#{CNT} 	,#{AGG} 	,#{AND_OR}
			,#{FIRST_YN} 	,#{BASE_DT_YN} 	,#{RANGE_CD} 	,#{RANGE_DN} 	,#{DELETE_YN} 	,#{ITEM_TEXT} 	,#{IS_NULL_OR_BLANK} 	,NOW() 	,NOW()
		
		)
	
	</insert>
	
	<!-- 조회조건상세정보 수정 -->
	<insert id="updateItemContDetl" parameterType="map">
		INSERT INTO CC_ITEM_CONT_DETL(	
			 SEQ 			,ITEM_SEQ 		,CONT_SEQ 		,PER_CODE 	,`ORDER` 	,INC_EXC 	,TAB_CD 	,GR_LV
			,INPUT_VAL0 	,INPUT_VAL1 	,INPUT_VAL2 	,CNT 		,AGG 		,AND_OR
			,FIRST_YN 		,BASE_DT_YN 	,RANGE_CD 		,RANGE_DN 	,DELETE_YN 	,ITEM_TEXT 	,IS_NULL_OR_BLANK 	,UDT_DT 	,CRT_DT
		
		)VALUES(
			 #{SEQ} 	,#{ITEM_SEQ} 	,#{CONT_SEQ} 	,#{PER_CODE} 	,#{ORDER} 	,#{INC_EXC} 	,#{TAB_CD} 	,#{GR_LV}
			,#{INPUT_VAL0} 	,#{INPUT_VAL1} 	,#{INPUT_VAL2} 	,#{CNT} 	,#{AGG} 	,#{AND_OR}
			,#{FIRST_YN} 	,#{BASE_DT_YN} 	,#{RANGE_CD} 	,#{RANGE_DN} 	,#{DELETE_YN} 	,#{ITEM_TEXT} 	,#{IS_NULL_OR_BLANK} 	,NOW() 	,NOW()
		
		)ON DUPLICATE KEY UPDATE SEQ = #{SEQ},
							INC_EXC=#{INC_EXC},
							TAB_CD=#{TAB_CD},
							GR_LV=#{GR_LV},
							INPUT_VAL0=#{INPUT_VAL0},
							INPUT_VAL1=#{INPUT_VAL1},
							INPUT_VAL2=#{INPUT_VAL2},
							`ORDER`=#{ORDER},
							CNT=#{CNT},
							AGG=#{AGG},
							AND_OR=#{AND_OR},
							FIRST_YN=#{FIRST_YN},
							BASE_DT_YN=#{BASE_DT_YN},
							RANGE_CD=#{RANGE_CD},
							RANGE_DN=#{RANGE_DN},
							RANGE_DN=#{DELETE_YN},
							ITEM_TEXT=#{ITEM_TEXT},
							IS_NULL_OR_BLANK=#{IS_NULL_OR_BLANK},
							UDT_DT=NOW() 
	
	</insert>
	
	<!-- 조회조건상세정보 삭제 -->
	<delete id="deleteItemContDetl" parameterType="map">
		DELETE FROM CC_ITEM_CONT_DETL 
		WHERE CONT_SEQ=#{CONT_SEQ}
		<if test="TAB_CD != null and TAB_CD != ''">
		AND TAB_CD='P'
		</if>
	
	</delete>
	
	
	<!-- 조건별 데이터 목록 -->
	<select id="selectItemContData" resultType="hashmap" parameterType="map">
		SELECT  *
		FROM	CC_ITEM_CONT_DATA A
		WHERE 	1=1
		AND 	A.CONT_SEQ = #{SEARCH_ITEM_CONT_SEQ}
		AND 	A.SEQ = #{SEARCH_DATA_ID}
	
	</select>
	
	<!-- 연구항목조건 공유 저장 -->
	<insert id="insertItemContShared" parameterType="map" useGeneratedKeys="true" keyProperty="SEQ">
		INSERT INTO CC_ITEM_CONT(
			 SHARE_CD
			,CONDT_NM
			,PER_CODE
			,METH_CD
			,CC_POP_NUM
			,CC_CASE_NUM
			,CC_SAM_NUM
			,CC_CONT_CD
			,CC_MAT_CD
			,UDT_DT
			,CRT_DT
			,SAVE_CD
			,DEPT_CODE
			,CC_AGE_NUM
			,INSTCD
		)
		SELECT 	 #{SHARE_CD}
				,#{CONDT_NM}
				,#{PER_CODE}
				,ITEM.METH_CD
				,ITEM.CC_POP_NUM
				,ITEM.CC_CASE_NUM
				,ITEM.CC_SAM_NUM
				,ITEM.CC_CONT_CD
				,ITEM.CC_MAT_CD
				,NOW()
				,NOW()
				,ITEM.SAVE_CD
				<choose>
					<!-- 개인공유일때 사용자의 부서코드 설정 -->
					<when test='SHARE_CD == "S"'>
						,(
							SELECT DEPT_CODE 
							FROM CC_PERINX 
							WHERE PER_CODE=#{PER_CODE}
							<if test="INSTCD != null and INSTCD != ''">
							AND INSTCD=#{INSTCD}
							</if> 
							LIMIT 1
						) AS DEPT_CODE
					</when>
					
					<!-- 과,전체공유일때 넘어온 파라미터로 부서코드 설정 -->
					<otherwise>
						,#{DEPT_CODE}
					</otherwise>
				</choose>
				,ITEM.CC_AGE_NUM
				,ITEM.INSTCD
		FROM	CC_ITEM_CONT ITEM
		WHERE	ITEM.SEQ=#{CONT_SEQ}
		
	</insert>
	
	<!-- 연구항목상세조건 공유 저장 -->
	<insert id="insertItemContDetlShared" parameterType="map">
		INSERT INTO CC_ITEM_CONT_DETL
		(
			 ITEM_SEQ
			,CONT_SEQ
			,PER_CODE
			,`ORDER`
			,INC_EXC
			,TAB_CD
			,GR_LV
			,INPUT_VAL0
			,INPUT_VAL1
			,INPUT_VAL2
			,CNT
			,AGG
			,AND_OR
			,FIRST_YN
			,BASE_DT_YN
			,RANGE_CD
			,RANGE_DN
			,DELETE_YN
			,ITEM_TEXT
			,IS_NULL_OR_BLANK
			,UDT_DT
			,CRT_DT
		)
		SELECT 	 DETL.ITEM_SEQ
				,#{SEQ}
				<choose>
					<when test='SHARE_CD == "S"'>
						,#{PER_CODE}
					</when>
					
					<otherwise>
						,DETL.PER_CODE	
					</otherwise>
				</choose>
				,DETL.ORDER
				,DETL.INC_EXC
				,DETL.TAB_CD
				,DETL.GR_LV
				,DETL.INPUT_VAL0
				,DETL.INPUT_VAL1
				,DETL.INPUT_VAL2
				,DETL.CNT
				,DETL.AGG
				,DETL.AND_OR
				,DETL.FIRST_YN
				,DETL.BASE_DT_YN
				,DETL.RANGE_CD
				,DETL.RANGE_DN
				,DETL.DELETE_YN
				,DETL.ITEM_TEXT
				,DETL.IS_NULL_OR_BLANK
				,DETL.UDT_DT
				,DETL.CRT_DT
		FROM CC_ITEM_CONT_DETL DETL
		WHERE DETL.CONT_SEQ=#{CONT_SEQ}
	
	</insert>
	
	
	<!-- 결과목록 테이블 존재여부 -->
	<select id="selectDataResultTableCount" parameterType="map" resultType="hashmap">
		SELECT 	COUNT(*) AS CNT 
		FROM 	TABLES 
		WHERE 1=1
		AND 	TABLE_SCHEMA || '.' || TABLE_NAME=#{TABLE_ID}
		
	</select>
	
	<!-- 결과목록 테이블 삭제 -->
	<delete id="dropTableDataResult" parameterType="map">
		${QUERY}
	</delete>
	
	<!-- 연구항목데이터  삭제 -->
	<delete id="deleteItemContData" parameterType="map">
		DELETE FROM CC_ITEM_CONT_DATA
		WHERE SEQ=#{SEQ}
	</delete>
	
	<!-- 연구항목데이터 상세정보 삭제 -->
	<delete id="deleteItemContDataDetl" parameterType="map">
		DELETE FROM CC_ITEM_CONT_DATA_DETL
		WHERE DATA_SEQ=#{DATA_SEQ}
	</delete>
	
	
	
	

</mapper>
 
 
 