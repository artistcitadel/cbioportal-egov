<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC
        "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="patientcpm">

    <select id="selectPatientCategory" resultType="com.asan.patient.vo.Patient">
        SELECT DISTINCT ITEM_CATE_ID subject , ITEM_ID id, ITEM_NM name FROM PMSPORTAL.CC_ITEM_MGMT
        WHERE PROGRM_ID = 'PATIENT_TIME' AND LENGTH(ITEM_ID)>0 AND DEFAULT_YN = 'Y'
    </select>

    <select id="selectPatientMutCol" resultType="com.asan.patient.vo.Patient">
        SELECT DISTINCT ITEM_CATE_ID subject, ITEM_ID id , ITEM_NM name FROM PMSPORTAL.CC_ITEM_MGMT
        WHERE PROGRM_ID = 'PATIENT_MUTATION' AND LENGTH(ITEM_ID)>0 AND DEFAULT_YN = 'Y'
    </select>

    <select id="selectPatientChoiceList" resultType="com.asan.patient.vo.Patient">
      SELECT DISTINCT
                RESCH_PAT_ID patientId,
                'xxxx' sampleId,
                '9999' age,
                'xxxx' cancerStudy,
                'xxxxx' cancerType,
                'xxxx' cancerTypeDetail
     FROM CLSPNEXRT
    </select>

    <select id="selectLabTestHrc" resultType="com.asan.patient.vo.Patient">
      SELECT DISTINCT
                'Lab_test' subject,
                EXAM_CD id,
                IFNULL(EXAM_ENG_NM, EXAM_CD) name
                FROM CLSPNEXRT
      <![CDATA[
        WHERE LENGTH(EXAM_CD) < 6
      ]]>
    </select>

    <select id="selectLabTest" resultType="com.asan.patient.vo.Patient">
     SELECT
     'Lab_test' subject,
     EXAM_SLIP_CD pid ,
                         EXAM_CD id,
                         IFNULL(EXAM_ENG_NM, EXAM_CD) name,
                         RCEP_DT time,
                         ROUND(IFNULL(SUM(EXAM_RSLT_VAL),0),2) exam,
                         ROUND(IFNULL(SUM(MARK_RSLT_VAL),0),2) mark,
                         ROUND(IFNULL(SUM(CRTE_MSR_VAL),0),2)  crte

        FROM CLSPNEXRT
        /*WHERE RESCH_PAT_ID = '6905950076' AND EXAM_CD IN ('DA0036','BD0012','BA0094') AND SUBSTRING(RCEP_DT,1,4) = '2017' OR (EXAM_CD='BD0012' AND RCEP_DT='20040427')*/
        WHERE RESCH_PAT_ID = '6905950076' /*AND EXAM_CD = 'AFIN'*/
        /*AND EXAM_ENG_NM = 'Rh variant Ag,Automation (Semi-Qn)[Agglutination],Blood'*/
        GROUP BY EXAM_SLIP_CD, EXAM_CD, EXAM_ENG_NM, RCEP_DT
        ORDER BY 2,3,5
        LIMIT  100
 	</select>

    <select id="selectPatientMuList_temp" resultType="com.asan.patient.vo.PatientMut">
    SELECT MTTN_EXAM_RSLT_ID mttnExamRsltId,
            RESCH_PAT_ID reschPatId,
            GENE_EXAM_SPCN_ID geneExamSpcnId,
            EXAM_NO examNo,
            GENE_EXAM_MTH_NM geneExamMthNm,
            CHRM_NO chrnNo,
            GENE_NM geneNm,
            GENE_VARI_ST_LOC_VAL geneVariStLocVal,
            GENE_VARI_END_LOC_VAL geneVariEndLocVal,
            DNA_STRND_VAL dnaStandVal,
            GENE_VARI_CLSF_NM geneVariClsfNm,
            GENE_VARI_TYP_NO geneVariTypNo,
            REF_ALLELE_SQNC_VAL refAlleleSqncVal,
            VARI_ALLELE_SQNC_VAL variAlleleSqncVal,
            MTTN_STAT_NO mttnStatNo,
            HGVSC_VAL hgvscVal,
            HGVSP_VAL hgvspVal,
            TOT_ALLELE_READ_CNT totAlleleReadCnt,
            REF_ALLELE_READ_CNT refAlleleReadCnt,
            VARI_ALLELE_READ_CNT variAlleleReadCnt,
            VARI_ALLELE_READ_RT variAlleleReadRt,
            EXON_LOC_VAL exonLocVal,
            INTRN_LOC_VAL intrnLocVal,
            TRSC_ID trscId
            FROM PMGERMUEM
            WHERE RESCH_PAT_ID = #{patientId}
 	</select>

    <select id="selectPatientMutAxis" resultType="com.asan.patient.vo.PatientMut">
        SELECT CHRM_NO chrmNo,
        GENE_ST_LOC_VAL geneStLocVal,
        GENE_END_LOC_VAL geneEndLocVal
        FROM PMGEMCHRM
        ORDER BY SORT_SEQ
    </select>
    <select id="selectPatientMuList" resultType="com.asan.patient.vo.PatientMut">
       SELECT GMU.MTTN_EXAM_RSLT_ID mttnExamRsltId        -- 돌연변이검사결과ID (화면표시X)
     , GMU.GENE_NM geneNm                  -- Gene
     , GMU.GENE_EXAM_MTH_NM geneExamMthNm         -- Methods
     , GMU.HGVSP_VAL  hgvspVal               -- Protein Change
     , GMU.CHRM_NO chrnNo                  -- Chromosome
     , GMU.GENE_VARI_ST_LOC_VAL  geneVariStLocVal    -- Start Pos
     , GMU.GENE_VARI_END_LOC_VAL    geneVariEndLocVal -- End Pos
     , GMU.REF_ALLELE_SQNC_VAL     refAlleleSqncVal  -- Ref
     , GMU.VARI_ALLELE_SQNC_VAL     variAlleleSqncVal -- Var
     , MST.MTTN_STAT_NM     ms         -- MS
     , GMU.GENE_VARI_CLSF_NM  geneVariClsfNm       -- Mutation Type
     , GMU.VARI_ALLELE_READ_RT  variAlleleReadRt     -- Allele Freq
     , GMU.TOT_ALLELE_READ_CNT  totAlleleReadCnt     -- 총대립유전자리드수 (화면표시X)
     , GMU.VARI_ALLELE_READ_CNT  variAlleleReadCnt    -- Variant Reads
     , GMU.REF_ALLELE_READ_CNT   refAlleleReadCnt    -- Ref Reads
     , CASE WHEN GCV.GENE_NM IS NULL THEN 'Diploid' ELSE 'Amplification' END AS copy   -- Copy #
             , SUM(MCS.GENE_VARI_OCCUR_CNT) cosmic -- COSMIC
             , NULL                          -- 암종 (화면표시X Annotation OncoKB 사용)
          FROM pmsdev.PMGERMUEM GMU
          LEFT OUTER JOIN pmsdev.PMGERMUCS MCS
            ON GMU.MTTN_EXAM_RSLT_ID = MCS.MTTN_EXAM_RSLT_ID
          LEFT OUTER JOIN pmsdev.PMGEMMUST MST
            ON GMU.MTTN_STAT_NO = MST.MTTN_STAT_NO
          LEFT OUTER JOIN pmsdev.PMGERCVEM GCV
            ON GMU.RESCH_PAT_ID = GCV.RESCH_PAT_ID
           AND GMU.GENE_NM      = GCV.GENE_NM
             , ( SELECT COUNT(*) AS PAT_CNT   -- 전체환자수
                   FROM ( SELECT RESCH_PAT_ID FROM pmsdev.PMGERMUEM
                           UNION
                          SELECT RESCH_PAT_ID FROM pmsdev.PMGERCVEM
                           UNION
                          SELECT RESCH_PAT_ID FROM pmsdev.PMGERSVEM
                           UNION
                          SELECT RESCH_PAT_ID FROM pmsdev.PMGERGNEX ) PAT_ALL
               ) PAT
        /* WHERE GMU.RESCH_PAT_ID = '10510117' -- 연구환자ID (조회조건)*/
         GROUP BY
               GMU.MTTN_EXAM_RSLT_ID
             , GMU.GENE_NM
             , GMU.GENE_EXAM_MTH_NM
             , GMU.HGVSP_VAL
             , GMU.CHRM_NO
             , GMU.GENE_VARI_ST_LOC_VAL
             , GMU.GENE_VARI_END_LOC_VAL
             , GMU.REF_ALLELE_SQNC_VAL
             , GMU.VARI_ALLELE_SQNC_VAL
             , MST.MTTN_STAT_NM
             , GMU.GENE_VARI_CLSF_NM
             , GMU.VARI_ALLELE_READ_RT
             , GMU.VARI_ALLELE_READ_CNT
             , GMU.REF_ALLELE_READ_CNT
    </select>

    <select id="selectPatientCNAList" resultType="com.asan.patient.vo.PatientMut">
      /* Copy Number Alterations */
        SELECT GCV.CNV_EXAM_RSLT_ID cnvExamRsltid          -- 복제수변이검사결과ID (화면표시X)
             , GCV.GENE_NM geneNm                   -- Gene (Annotation OncoKB 사용)
             , GCV.GENE_EXAM_MTH_NM geneExamMthNm          -- Methods
             , UPPER(GCV.CNV_STAT_NM) AS cna -- CNA (Annotation OncoKB 사용)
             , GCV.CYTB_NM cytbNm                   -- Cytoband
             , ROUND((SELECT COUNT(*) FROM pmsdev.PMGERCVEM WHERE GENE_NM = GCV.GENE_NM) / PAT.PAT_CNT * 100, 1) AS COHORT_1   -- Cohort (밝은색)
             , ROUND((SELECT COUNT(*) FROM pmsdev.PMGERCVEM WHERE GENE_NM = GCV.GENE_NM AND CNV_STAT_NM = GCV.CNV_STAT_NM) / PAT.PAT_CNT * 100, 1) AS COHORT_2   -- Cohort (진한색)

        ,GCV.RESCH_PAT_ID
          FROM pmsdev.PMGERCVEM GCV
             , ( SELECT COUNT(*) AS PAT_CNT   -- 전체환자수
                   FROM ( SELECT RESCH_PAT_ID FROM pmsdev.PMGERMUEM
                           UNION
                          SELECT RESCH_PAT_ID FROM pmsdev.PMGERCVEM
                           UNION
                          SELECT RESCH_PAT_ID FROM pmsdev.PMGERSVEM
                           UNION
                          SELECT RESCH_PAT_ID FROM pmsdev.PMGERGNEX ) PAT_ALL
               ) PAT
        WHERE GCV.RESCH_PAT_ID = '51927545'

    </select>

    <select id="selectPatientEXPList" resultType="com.asan.patient.vo.PatientMut">
         SELECT GEX.GENE_NM geneNm                 -- Gene
         , GEX.GENE_EXAM_MTH_NM geneExamMthNm       -- Methods
         , GEX.PTEG_GENE_READ_RSLT_VAL ptegGeneReadRsltVal   -- Expression Result
         , CASE WHEN GEX.GENE_EXAM_MTH_NM = 'NGS' THEN GEX.NGS_GNEX_VAL ELSE GEX.PTEG_GNEX_VAL END AS gnex -- Expression Value
         , GEX.GNEX_MSR_VAL gnexMsrVal              -- Expression Unit
      FROM pmsdev.PMGERGNEX GEX
    WHERE GEX.RESCH_PAT_ID = '3133581171'
    </select>

    <select id="selectPatientSTRList" resultType="com.asan.patient.vo.PatientMut">
/* Structural Variations */
      SELECT GSV.SV_EXAM_RSLT_ID svExamRsltId     -- 구조변이검사결과ID (화면표시X)
     , GSV.GENE_NM1 geneNm1                  -- Gene1 (Annotation OncoKB 사용)
     , GSV.GENE_NM2 geneNm2                  -- Gene2 (Annotation OncoKB 사용)
     , GSV.GENE_EXAM_MTH_NM geneExamMthNm    -- Methods
     , GSV.CYTB_NM1 cytbNm1                 -- Cytoband1
     , GSV.CYTB_NM2 cytbNm2                  -- Cytoband2
     , ROUND((SELECT COUNT(*) FROM pmsdev.PMGERSVEM WHERE GENE_NM1 = GSV.GENE_NM1) / PAT.PAT_CNT * 100, 1) AS COHORT_1   -- Cohort1 (밝은색)
     , ROUND((SELECT COUNT(*) FROM pmsdev.PMGERSVEM WHERE GENE_NM2 = GSV.GENE_NM2) / PAT.PAT_CNT * 100, 1) AS COHORT_2   -- Cohort2 (밝은색)
     , NULL                           -- 암종 (Annotation OncoKB 사용)
  FROM pmsdev.PMGERSVEM GSV
     , ( SELECT COUNT(*) AS PAT_CNT   -- 전체환자수
           FROM ( SELECT RESCH_PAT_ID FROM pmsdev.PMGERMUEM
                   UNION
                  SELECT RESCH_PAT_ID FROM pmsdev.PMGERCVEM
                   UNION
                  SELECT RESCH_PAT_ID FROM pmsdev.PMGERSVEM
                   UNION
                  SELECT RESCH_PAT_ID FROM pmsdev.PMGERGNEX ) PAT_ALL
       ) PAT
 WHERE GSV.RESCH_PAT_ID = '7278840302'  -- 연구환자ID (조회조건)
    </select>

    <select id="selectPatientMuCosmic" resultType="com.asan.patient.vo.PatientMut">
       /*SELECT MCS.CSMC_ID csmcId                -- COSMIC ID
       , MCS.MTTN_EXAM_RSLT_ID mttnExamRsltId
       , MCS.HGVSP_VAL hgvspVal               -- Protein Change
       , MCS.GENE_VARI_OCCUR_CNT geneVariOccurCnt     -- Occurrence
       FROM pmsdev.PMGERMUCS MCS
       WHERE MCS.MTTN_EXAM_RSLT_ID = 'SNM0000039124'      -- 돌연변이검사결과ID (조회조건)*/
       WITH
        T1
          AS (
              SELECT MCS.CSMC_ID,
                     MCS.MTTN_EXAM_RSLT_ID,
                     MCS.HGVSP_VAL,
                     MCS.GENE_VARI_OCCUR_CNT
              FROM pmsdev.PMGERMUCS MCS
          )
        ,
        T2 AS (
        SELECT GMU.MTTN_EXAM_RSLT_ID         -- 돌연변이검사결과ID (화면표시X)
             , GMU.GENE_NM                   -- Gene (Annotation OncoKB 사용)
             , GMU.GENE_EXAM_MTH_NM          -- Methods
             , UPPER(GMU.HGVSP_VAL) AS HGVSP -- Protein Change (Annotation OncoKB 사용)
             , GMU.CHRM_NO                   -- Chromosome
             , GMU.GENE_VARI_ST_LOC_VAL      -- Start Pos
             , GMU.GENE_VARI_END_LOC_VAL     -- End Pos
             , GMU.REF_ALLELE_SQNC_VAL       -- Ref
             , GMU.VARI_ALLELE_SQNC_VAL      -- Var
             , MST.MTTN_STAT_NM              -- MS
             , GMU.GENE_VARI_CLSF_NM         -- Mutation Type
             , GMU.VARI_ALLELE_READ_RT       -- Allele Freq
             , GMU.TOT_ALLELE_READ_CNT       -- 총대립유전자리드수 (화면표시X Allele Freq 마우스 오버 사용)
             , GMU.VARI_ALLELE_READ_CNT      -- Variant Reads
             , GMU.REF_ALLELE_READ_CNT       -- Ref Reads
             , CASE WHEN GCV.GENE_NM IS NULL THEN 'Diploid' ELSE 'Amplification' END AS COPY   -- Copy #
             , ROUND((SELECT COUNT(DISTINCT RESCH_PAT_ID) FROM pmsdev.PMGERMUEM WHERE GENE_NM = GMU.GENE_NM) / ANY_VALUE(PAT.PAT_CNT) * 100, 1) AS COHORT_1   -- Cohort (밝은색)
             , ROUND((SELECT COUNT(DISTINCT RESCH_PAT_ID) FROM pmsdev.PMGERMUEM WHERE GENE_NM = GMU.GENE_NM AND HGVSP_VAL = GMU.HGVSP_VAL) / ANY_VALUE(PAT.PAT_CNT) * 100, 1) AS COHORT_2   -- Cohort (진한색)
             , SUM(MCS.GENE_VARI_OCCUR_CNT)  -- COSMIC
             , NULL                          -- 암종 (화면표시X Annotation OncoKB 사용)
          FROM pmsdev.PMGERMUEM GMU
          LEFT OUTER JOIN pmsdev.PMGERMUCS MCS
            ON GMU.MTTN_EXAM_RSLT_ID = MCS.MTTN_EXAM_RSLT_ID
          LEFT OUTER JOIN pmsdev.PMGEMMUST MST
            ON GMU.MTTN_STAT_NO = MST.MTTN_STAT_NO
          LEFT OUTER JOIN pmsdev.PMGERCVEM GCV
            ON GMU.RESCH_PAT_ID = GCV.RESCH_PAT_ID
           AND GMU.GENE_NM      = GCV.GENE_NM
             , ( SELECT COUNT(*) AS PAT_CNT   -- 전체환자수
                   FROM ( SELECT RESCH_PAT_ID FROM pmsdev.PMGERMUEM
                           UNION
                          SELECT RESCH_PAT_ID FROM pmsdev.PMGERCVEM
                           UNION
                          SELECT RESCH_PAT_ID FROM pmsdev.PMGERSVEM
                           UNION
                          SELECT RESCH_PAT_ID FROM pmsdev.PMGERGNEX ) PAT_ALL
               ) PAT
        /* WHERE GMU.RESCH_PAT_ID = '10510117' -- 연구환자ID (조회조건)*/
         GROUP BY
               GMU.MTTN_EXAM_RSLT_ID
             , GMU.GENE_NM
             , GMU.GENE_EXAM_MTH_NM
             , GMU.HGVSP_VAL
             , GMU.CHRM_NO
             , GMU.GENE_VARI_ST_LOC_VAL
             , GMU.GENE_VARI_END_LOC_VAL
             , GMU.REF_ALLELE_SQNC_VAL
             , GMU.VARI_ALLELE_SQNC_VAL
             , MST.MTTN_STAT_NM
             , GMU.GENE_VARI_CLSF_NM
             , GMU.VARI_ALLELE_READ_RT
             , GMU.VARI_ALLELE_READ_CNT
             , GMU.REF_ALLELE_READ_CNT
        )
        SELECT T1.CSMC_ID  csmcId,
                T1.MTTN_EXAM_RSLT_ID  mttnExamRsltId,
                T1.HGVSP_VAL hgvspVal,
                T1.GENE_VARI_OCCUR_CNT geneVariOccurCnt
        FROM T1, T2
        WHERE T1.MTTN_EXAM_RSLT_ID = T2.MTTN_EXAM_RSLT_ID

    </select>

</mapper>


