<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC  
 "-//mybatis.org//DTD Mapper 3.0//EN"  
 "http://mybatis.org/dtd/mybatis-3-mapper.dtd">  
 
 
 <mapper namespace="user">
 
 	<!-- 사용자 카운트 조회 -->
	<select id="selectPerInxCount" parameterType="map" resultType="java.lang.Integer">
		SELECT COUNT(*) AS TOT_CNT
		FROM CC_PERINX A
		LEFT OUTER JOIN CC_DEPINX B ON (A.DEPT_CODE = B.DEPT_CODE)
		LEFT OUTER JOIN CC_LOTINX C ON (A.LOCT_CODE = C.LOCT_CODE)
		WHERE 1=1
		<if test="SEARCH_VAL != null and SEARCH_VAL != ''">
			<choose>
				<when test="SEARCH_KEY == '001'">
					AND A.PER_CODE LIKE CONCAT('%',#{SEARCH_VAL},'%')
				</when>
				<when test="SEARCH_KEY == '002'">
					AND A.PER_NAME LIKE CONCAT('%',#{SEARCH_VAL},'%')
				</when>
				<when test="SEARCH_KEY == '003'">
					AND B.DEPT_NAME LIKE CONCAT('%',#{SEARCH_VAL},'%')
				</when>
				<when test="SEARCH_KEY == '004'">
					AND C.LOCT_NAME LIKE CONCAT('%',#{SEARCH_VAL},'%')
				</when>
				
				<otherwise>
					AND 
					(
							A.PER_CODE LIKE CONCAT('%',#{SEARCH_VAL},'%') 
							OR	A.PER_NAME LIKE CONCAT('%',#{SEARCH_VAL},'%')
							OR	B.DEPT_NAME LIKE CONCAT('%',#{SEARCH_VAL},'%') 
							OR	C.LOCT_NAME LIKE CONCAT('%',#{SEARCH_VAL},'%')
					)
				
				</otherwise>
			</choose>
		</if>
		<if test="SEARCH_NOT_PER_CODE != null and SEARCH_NOT_PER_CODE != ''">
		AND 	A.PER_CODE &lt;&gt; #{SEARCH_NOT_PER_CODE}
		</if>
	</select>
 
 	<!-- 사용자 조회 -->
	<select id="selectPerInxList" parameterType="map" resultType="hashmap">
		SELECT *
		FROM	
		(
			SELECT @RNUM := @RNUM + 1 AS NUM,
				 TB1.PER_CODE
				,TB1.PER_PASS         /* 사용자 비밀번호 */
				,TB1.PER_NAME         /* 사용자 이름 */
				,TB1.DEPT_CODE        /* 부서 코드 */				
				,TB1.DEPT_NAME        /* 부서명 */
				,TB1.DEPT_MAST        /* 부서MAST */
				,IFNULL(TB1.INSTCD,'') AS INSTCD
				,(SELECT COMM_CD_NM FROM CC_COMMON_CODE WHERE COMM_GRP_ID='CDW_INSTCD' AND COMM_CD_ID=TB1.INSTCD) AS INSTNM
				,TB1.LOCT_CODE        /*  */
				,TB1.LOCT_NAME        /*  */
				,'' AS CHKVAL
			FROM
			(
				SELECT   CONVERT(A.PER_CODE USING utf8) AS 'PER_CODE'      /* 사용자 ID */
						,A.PER_PASS         /* 사용자 비밀번호 */
						,A.PER_NAME         /* 사용자 이름 */
						,A.DEPT_CODE        /* 부서 코드 */				
						,B.DEPT_NAME        /* 부서명 */
						,B.DEPT_MAST        /* 부서MAST */
						<if test="SEARCH_INSTCD_YN != null and SEARCH_INSTCD_YN != ''">
							<choose>
								<when test='SEARCH_INSTCD_YN == "Y"'>
									,A.INSTCD
								</when>
								<otherwise>
									,'' AS INSTCD
								</otherwise>
							</choose>
						</if>
						,A.LOCT_CODE        /*  */
						,C.LOCT_NAME        /*  */
				FROM CC_PERINX A
				LEFT OUTER JOIN CC_DEPINX B ON (A.DEPT_CODE = B.DEPT_CODE)
				LEFT OUTER JOIN CC_LOTINX C ON (A.LOCT_CODE = C.LOCT_CODE)
				WHERE 1=1
				<if test="SEARCH_VAL != null and SEARCH_VAL != ''">
					<choose>
						<when test="SEARCH_KEY == '001'">
							AND A.PER_CODE LIKE CONCAT('%',#{SEARCH_VAL},'%')
						</when>
						<when test="SEARCH_KEY == '002'">
							AND A.PER_NAME LIKE CONCAT('%',#{SEARCH_VAL},'%')
						</when>
						<when test="SEARCH_KEY == '003'">
							AND B.DEPT_NAME LIKE CONCAT('%',#{SEARCH_VAL},'%')
						</when>
						<when test="SEARCH_KEY == '004'">
							AND C.LOCT_NAME LIKE CONCAT('%',#{SEARCH_VAL},'%')
						</when>
						
						<otherwise>
							AND 
							(
									A.PER_CODE LIKE CONCAT('%',#{SEARCH_VAL},'%')
									OR	A.PER_NAME LIKE CONCAT('%',#{SEARCH_VAL},'%')
									OR	B.DEPT_NAME LIKE CONCAT('%',#{SEARCH_VAL},'%')
									OR	C.LOCT_NAME LIKE CONCAT('%',#{SEARCH_VAL},'%')
							)
						
						</otherwise>
					</choose>
				</if>
				
				<if test="SEARCH_NOT_PER_CODE != null and SEARCH_NOT_PER_CODE != ''">
				AND 	A.PER_CODE &lt;&gt; #{SEARCH_NOT_PER_CODE}
				</if>
				ORDER BY A.PER_CODE ASC
				
				
			)TB1 ,
			(SELECT @RNUM := 0 ) R
		)TB1 WHERE 1=1
		LIMIT #{start},#{length}
		
	</select>
	
	
	<!-- 비밀번호변경 -->
	<update id="updatePerInx" parameterType="map">
		UPDATE CC_PERINX
		SET 	 PER_PASS=#{PER_PASS},
				 UDT_ID=#{UDT_ID},
				 UDT_DT=NOW()
		WHERE	 1=1
		AND 	 PER_CODE=#{PER_CODE}
		<!-- 경북대 추가
		<if test="HOSPITAL_CODE != null and HOSPITAL_CODE != ''">
		AND INSTCD = #{HOSPITAL_CODE} 
		</if>
		 -->
		
		<!-- 경북대 추가
		<if test="INSTCD != null and INSTCD != ''">
		AND INSTCD = #{INSTCD} 
		</if>
		 -->
		
	</update>
	<select id="selectPerinxAllList" parameterType="map"
		resultType="hashmap">
		SELECT * FROM CC_PERINX 
		
	</select>
	
</mapper>
 
 
 