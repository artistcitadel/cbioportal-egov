<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC  
 "-//mybatis.org//DTD Mapper 3.0//EN"  
 "http://mybatis.org/dtd/mybatis-3-mapper.dtd">  
 
 
 <mapper namespace="dashboard">
 	
 	<select id="selectDashboardSummary" parameterType="map" resultType="hashmap">
 		SELECT 	* 
		FROM 	CC_DASHBOARD 
		WHERE 	1=1 
		AND 	DATE = ( 
			SELECT DATE FROM CC_DASHBOARD ORDER BY DATE DESC limit 1 
		) 
		ORDER BY CASE 	WHEN DSTC = '환자' THEN 1 
						WHEN DSTC = '진단' THEN 2 
						WHEN DSTC = '처방' THEN 3 
						WHEN DSTC = '의무기록' 
						THEN 4 END
 	</select>
 	
 	<!-- DASHBOARD -->
 	<select id="selectDashboard" resultType="hashmap">
 		SELECT   A.SERVICE_STAT_SQL
				,A.RESEARCH_TARGET_STAT_SQL
				,A.SHOW_MY_RESEARCH
				,A.SUMMARY_WIDTH
				,A.SHOW_MY_RESEARCH
		FROM	CC_DASHBOARD A
		WHERE	1=1
	</select>
 	
 	<!-- DASHBOARD CHART -->
 	<select id="selectDashboardChart" parameterType="map" resultType="hashmap">
 		SELECT  A.TITLE
				,A.TYPE
				,A.DATA_SQL
				,A.WIDTH
				,A.MIN_HEIGHT
				,A.SHOW_YN
				,A.ORDER_NUM
				,A.DIM
				,A.MEASURE
				,A.COLS
		FROM	CC_DASHBOARD_CHART A
		WHERE	1=1
		AND 	A.SHOW_YN='Y'
		ORDER BY A.ORDER_NUM
 	</select>
 	
 	<!-- DASHBOARD BOARD -->
 	<select id="selectDashboardBoard" parameterType="map" resultType="hashmap">
 		SELECT  A.SEQ
 				,A.TITLE
				,A.LIST_COUNT_DASHBOARD
				,A.LIST_COUNT_COMMON
				,A.WIDTH
				,A.AUTH_CODE
				,A.ATTACH_YN
				,A.SHOW_DASHBOARD_GBN
		FROM	CC_BOARD_MGMT A
		WHERE	1=1
		AND 	A.SHOW_DASHBOARD_YN='Y'
		ORDER BY A.ORDER_NUM
 	</select>
 	
 	<!-- DASHBOARD BOARD LIST -->
 	<select id="selectDashboardBoardList" parameterType="map" resultType="hashmap">
 		SELECT @RNUM := @RNUM + 1 AS NUM,
				B.*
		FROM
		(
	 		SELECT  DISTINCT C.PER_NAME
	 				,A.SEQ
	 				,A.BOARD_SEQ
	 				,A.TITLE
					,A.VISIT
					,DATE_FORMAT(A.CRT_DT, '%Y-%m-%d %H:%i') AS CRT_DT
					,DATE_FORMAT(A.UDT_DT, '%Y-%m-%d %H:%i') AS UDT_DT
					,A.CRT_ID
					,A.UDT_ID
			FROM	CC_BOARD A
			INNER JOIN CC_PERINX C
			ON A.UDT_ID = C.PER_CODE
			WHERE	1=1
			AND 	A.BOARD_SEQ = #{BOARD_SEQ}
			<if test="SEARCH_VAL != null and SEARCH_VAL != ''">
				<choose>
					<when test="SEARCH_KEY == 1">
						AND A.TITLE LIKE CONCAT('%',#{SEARCH_VAL},'%')
					</when>
					<when test="SEARCH_KEY == 2">
						AND C.PER_NAME LIKE CONCAT('%',#{SEARCH_VAL},'%')
					</when>
				</choose>			
			</if>
		)B ,
		<choose>
			<when test="start != null and start != ''">
				(SELECT @RNUM := #{start} ) R
			</when>
			<otherwise>
				(SELECT @RNUM := 0 ) R
			</otherwise>
		</choose>
		
		ORDER BY B.SEQ DESC	
		<!-- <if test="LIST_COUNT_DASHBOARD != null and LIST_COUNT_DASHBOARD != ''">
			LIMIT #{LIST_COUNT_DASHBOARD}			
		</if> -->
		<choose>
			<when test="LIST_COUNT_DASHBOARD != null and LIST_COUNT_DASHBOARD != ''">
				LIMIT #{LIST_COUNT_DASHBOARD}
			</when>
			<otherwise>
				LIMIT #{start},#{length}
			</otherwise>
		</choose>
		
 	</select>
 	
 	<!-- 게시판 카운트 조회 -->
	<select id="selectDashboardBoardCount" parameterType="map" resultType="java.lang.Integer">
		SELECT  COUNT(*) AS TOT_CNT
			FROM	CC_BOARD A
			INNER JOIN CC_PERINX C
			ON A.UDT_ID = C.PER_CODE
			WHERE	1=1
			AND 	A.BOARD_SEQ = #{BOARD_SEQ}
			<if test="SEARCH_VAL != null and SEARCH_VAL != ''">
				<choose>
					<when test="SEARCH_KEY == 1">
						AND A.TITLE LIKE CONCAT('%',#{SEARCH_VAL},'%')
					</when>
					<when test="SEARCH_KEY == 2">
						AND C.PER_NAME LIKE CONCAT('%',#{SEARCH_VAL},'%')
					</when>
				</choose>			
			</if>
	</select>
 	
 	<select id="selectDashboardSvcStatus" parameterType="map"
 		resultType="hashmap">
 		<choose>
 			<when test='GV_DB_TYPE == "VERTICA" and GV_DB_TYPE == "VERTICA"'>
 				${SERVICE_STAT_SQL}
 			</when>
 			
 			<otherwise>
 				SELECT 		MAX(CPU_USAGE_TOTAL),
						    CASE
						        WHEN MAX(CPU_USAGE_TOTAL) &lt; 10
						        THEN '원활' WHEN MAX(CPU_USAGE_TOTAL) &lt; 50
						        THEN '보통' WHEN MAX(CPU_USAGE_TOTAL) &lt; 60
						        THEN '다소복잡'
						        ELSE '복잡'
						    END AS CODE,
						    CASE
						        WHEN MAX(CPU_USAGE_TOTAL) &lt;10
						        THEN '서비스 원활 (기준일시:' || MAX(CURRENT_TIMESTAMP) || ')' WHEN MAX(CPU_USAGE_TOTAL) &lt; 50
						        THEN '정상 서비스 중 (기준일시:' || MAX(CURRENT_TIMESTAMP) || ')' WHEN MAX(CPU_USAGE_TOTAL) &lt; 60
						        THEN '서비스 지연 (기준일시:' || MAX(CURRENT_TIMESTAMP) || ')'
						        ELSE '서비스 중지 (기준일시:)' || MAX(CURRENT_TIMESTAMP) || ')'
						    END AS MESSAGE
				FROM 	TABLE(SYSPROC.ENV_GET_SYSTEM_RESOURCES())
 			</otherwise>
 		
 		</choose>
 		
 	</select>
 	
 	
 	<select id="selectDashboardResearchTargetStat" parameterType="map"
 		resultType="hashmap">
 		${RESEARCH_TARGET_STAT_SQL}
 	</select>
 	
 	<select id="selectDashboardChartList" parameterType="map"
 		resultType="hashmap">
 		${CHART_SQL}
 	</select>
 	
 	<!-- 게시글 등록  -->
	<insert id="insertBoardData" parameterType="map" useGeneratedKeys="true" keyProperty="SEQ" >
		INSERT INTO CC_BOARD
		(                           
			BOARD_SEQ,					/* 게시판코드 */
			TITLE,						/* 제목 */
			CONTENT,					/* 내용 */
			CRT_DT,						/* 입력일 */
			UDT_DT,						/* 수정일 */
			UDT_ID,						/* 수정자 ID */
			CRT_ID						/* 생성자 ID */
		)
		VALUES
		(
			#{BOARD_SEQ},
			#{TITLE},
			#{CONTENT},
			NOW(),
			NOW(),
			#{UDT_ID},
			#{CRT_ID}
		)
	
	</insert>
	
	<!-- 게시글 첨부파일 등록  -->
	<insert id="insertBoardFileData" parameterType="map" >
		INSERT INTO CC_BOARD_ATTACH
		(   
			DOCUMENT_SEQ,
			BOARD_SEQ,
			ATTACH_PATH,
			ATTACH_SIZE,
			`ORDER`,
			UDT_DT,
			UDT_ID,
			CRT_ID,
			CRT_DT,
			SAVE_FILE_NAME,
			FILE_NAME
		)
		VALUES
		(
			#{SEQ},
			${BOARD_SEQ},
			#{repository},
			#{fileSize},
			#{ORDER},
			NOW(),
			#{UDT_ID},
			#{CRT_ID},
			NOW(),
			#{s_name},
			#{o_name}
		)
	
	</insert>
	
	<!-- 게시글 수정 -->
	<update id="updateBoardData" parameterType="map">
		UPDATE   CC_BOARD
		SET		 TITLE 					= #{TITLE},
				 CONTENT				= #{CONTENT},
				 UDT_DT					= NOW(),
				 UDT_ID					= #{UDT_ID}
		WHERE	1=1
		AND 	SEQ = #{SEQ}
	
	</update>
	
	<!-- 게시글 조회수+1 -->
	<update id="updateBoardVisit" parameterType="map">
		UPDATE   CC_BOARD
		SET		 VISIT 	= VISIT + 1
		WHERE	1=1
		AND 	SEQ = #{SEQ}
	
	</update>
	
	<!-- 게시글 삭제 -->
	<delete id="deleteBoardData" parameterType="map">
		delete  FROM  CC_BOARD
		WHERE	1=1
		AND 	SEQ = #{SEQ}
	
	</delete>

	<!-- 게시판 상세 -->
	<select id="selectBoardDataDetail" parameterType="map" resultType="hashmap">
 		SELECT  A.TITLE
				,A.VISIT
				,DATE_FORMAT(A.UDT_DT, '%Y-%m-%d %H:%i') AS UDT_DT
				,A.UDT_ID
				,A.CONTENT
				,C.PER_NAME
		FROM	CC_BOARD A
		INNER JOIN CC_PERINX C
		ON A.UDT_ID = C.PER_CODE
		WHERE	1=1
		AND 	A.SEQ= #{SEQ}
 	</select>
 	
 	<!-- 게시판 상세 첨부파일 -->
	<select id="selectBoardDataDetailFile" parameterType="map" resultType="hashmap">
 		SELECT 
			A.SEQ,
			A.ATTACH_PATH,
			A.ATTACH_SIZE,
			A.SAVE_FILE_NAME,
			A.FILE_NAME 
		FROM CC_BOARD_ATTACH A
		WHERE 1=1
			AND DOCUMENT_SEQ = #{SEQ}
		ORDER BY `ORDER` DESC
 	</select>
 	
 	<!-- 나의연구활동 -->
	<select id="selectMySaveData" parameterType="map" resultType="hashmap">
		
		SELECT 
			A.SEQ,
			A.CONDT_NM,
			A.PER_CODE,
			A.METH_CD,
			A.SAVE_CD,
			B.SEQ AS DATA_SEQ,
			B.TABLE_CNT,
			B.DATA_NM,
			(SELECT C.SEQ FROM CC_ITEM_CONT_DATA_DETL C WHERE C.DATA_SEQ=B.SEQ AND C.ADD_ITEM_YN='Y' LIMIT 0,1) AS CHART_SEQ,
			D.SEQ AS APRV_SEQ,
			D.APRV_YN,
			DATE_FORMAT(A.UDT_DT, '%Y-%m-%d %H:%i') AS UDT_DT,
			DATE_FORMAT(B.UDT_DT, '%Y-%m-%d %H:%i') AS DATA_UDT_DT
		FROM CC_ITEM_CONT A
		LEFT OUTER JOIN CC_ITEM_CONT_DATA B
		ON A.SEQ = B.CONT_SEQ
		LEFT OUTER JOIN CC_RSCH_APRV_MGMT D
		ON B.SEQ = D.DATA_SEQ
		WHERE 1=1
			AND A.SHARE_CD='P'
			AND A.PER_CODE=#{PER_CODE}
			AND A.METH_CD NOT IN ('RG')
		ORDER BY A.UDT_DT DESC, B.UDT_DT DESC
 	</select>
 	
 	<!-- chart 조회 -->
	<select id="selectChartMgmt" parameterType="map" resultType="hashmap">
		SELECT @RNUM := @RNUM + 1 AS NUM,
				A.*
		FROM
		(
			SELECT 
				SEQ,
				TITLE,
				TYPE,
				DATA_SQL,
				WIDTH,
				SHOW_YN,
				ORDER_NUM,
				DIM,
				MEASURE,
				COLS
			FROM CC_DASHBOARD_CHART 
			WHERE SHOW_YN = 'Y'
		)A ,
		(SELECT @RNUM := 0 ) R
		
		ORDER BY ORDER_NUM ASC
	</select>
	
	<!-- 첨부파일 개별 삭제 -->
	<delete id="deleteFile" parameterType="map">
		delete  FROM  CC_BOARD_ATTACH
		WHERE	1=1
		AND 	SEQ = #{SEQ}
	
	</delete>

</mapper>
 
 
 